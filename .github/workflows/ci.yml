# Nyon Engine Testing Configuration

# GitHub Actions CI Pipeline
name: Nyon Engine Tests

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master, develop ]
  workflow_dispatch:

jobs:
  test-linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        compiler: [g++, clang++]
        build_type: [Debug, Release]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          libglfw3-dev \
          libglm-dev \
          xorg-dev \
          libglu1-mesa-dev \
          freeglut3-dev \
          mesa-common-dev
      
    - name: Cache Build
      uses: actions/cache@v3
      with:
        path: build
        key: ${{ runner.os }}-${{ matrix.compiler }}-${{ matrix.build_type }}-${{ hashFiles('**/CMakeLists.txt') }}
        restore-keys: |
          ${{ runner.os }}-${{ matrix.compiler }}-${{ matrix.build_type }}-
    
    - name: Configure CMake
      run: |
        mkdir -p build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} -DENABLE_TESTING=ON
    
    - name: Build Tests
      run: |
        cd build
        make -j$(nproc) nyon_tests
    
    - name: Run Tests
      run: |
        cd build
        ./test/nyon_tests --gtest_output=xml:test_results.xml
    
    - name: Upload Test Results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results-${{ matrix.compiler }}-${{ matrix.build_type }}
        path: build/test_results.xml

  test-macos:
    runs-on: macos-latest
    strategy:
      matrix:
        build_type: [Debug, Release]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Install Dependencies
      run: |
        brew install cmake glfw glm
    
    - name: Configure CMake
      run: |
        mkdir -p build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} -DENABLE_TESTING=ON
    
    - name: Build Tests
      run: |
        cd build
        make -j$(sysctl -n hw.ncpu) nyon_tests
    
    - name: Run Tests
      run: |
        cd build
        ./test/nyon_tests --gtest_output=xml:test_results.xml

  coverage:
    runs-on: ubuntu-latest
    needs: test-linux
    steps:
    - uses: actions/checkout@v3
    
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          libglfw3-dev \
          libglm-dev \
          gcovr \
          lcov
    
    - name: Configure for Coverage
      run: |
        mkdir -p build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Debug -DENABLE_TESTING=ON -DCMAKE_CXX_FLAGS="--coverage"
    
    - name: Build with Coverage
      run: |
        cd build
        make -j$(nproc) nyon_tests
    
    - name: Run Tests with Coverage
      run: |
        cd build
        ./test/nyon_tests
    
    - name: Generate Coverage Report
      run: |
        cd build
        lcov --capture --directory . --output-file coverage.info
        lcov --remove coverage.info '/usr/*' '*/test/*' '*/build/*' --output-file coverage_filtered.info
        genhtml coverage_filtered.info --output-directory coverage_report
    
    - name: Upload Coverage Report
      uses: actions/upload-artifact@v3
      with:
        name: coverage-report
        path: build/coverage_report/

  benchmark:
    runs-on: ubuntu-latest
    needs: test-linux
    steps:
    - uses: actions/checkout@v3
    
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          libglfw3-dev \
          libglm-dev
    
    - name: Configure Release Build
      run: |
        mkdir -p build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release -DENABLE_TESTING=ON
    
    - name: Build Benchmarks
      run: |
        cd build
        make -j$(nproc) nyon_tests
    
    - name: Run Performance Tests
      run: |
        cd build
        ./test/nyon_tests --gtest_filter="*Performance*" --gtest_output=xml:benchmark_results.xml
    
    - name: Upload Benchmark Results
      uses: actions/upload-artifact@v3
      with:
        name: benchmark-results
        path: build/benchmark_results.xml

  analyze:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          libglfw3-dev \
          libglm-dev \
          cppcheck \
          clang-tools
    
    - name: Static Analysis with Cppcheck
      run: |
        cppcheck --enable=all --inconclusive --xml --xml-version=2 engine/ 2> cppcheck_results.xml
    
    - name: Upload Cppcheck Results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: cppcheck-results
        path: cppcheck_results.xml

  documentation:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Install Doxygen
      run: |
        sudo apt-get update
        sudo apt-get install -y doxygen graphviz
    
    - name: Generate Documentation
      run: |
        mkdir -p build
        cd build
        cmake .. -DBUILD_DOCUMENTATION=ON
        make doc
    
    - name: Upload Documentation
      uses: actions/upload-artifact@v3
      with:
        name: documentation
        path: build/docs/